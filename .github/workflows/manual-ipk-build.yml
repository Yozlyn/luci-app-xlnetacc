name: Manual IPK Build & Release

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: OpenWrt SDK download URL
        required: false
        default: https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
      package_name:
        description: Package name to build
        required: false
        default: luci-app-xlnetacc
      release_tag:
        description: Tag name for the release (auto-generated if empty)
        required: false
      release_name:
        description: Release title (auto-generated if empty)
        required: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison gawk gettext \
            libncurses5-dev libssl-dev python3-distutils python3-setuptools \
            rsync unzip wget

      - name: Download OpenWrt SDK
        run: |
          SDK_URL="${{ github.event.inputs.sdk_url }}"
          mkdir -p /tmp/sdk
          cd /tmp/sdk
          wget "$SDK_URL" -O sdk.tar.xz
          tar xf sdk.tar.xz
          sdk_dir=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -n 1)
          if [ -z "$sdk_dir" ]; then
            echo "SDK directory not found"
            exit 1
          fi
          sdk_dir="/tmp/sdk/$(basename "$sdk_dir")"
          if [ ! -x "$sdk_dir/scripts/feeds" ]; then
            echo "Invalid SDK directory structure"
            exit 1
          fi
          echo "SDK_DIR=$sdk_dir" >> $GITHUB_ENV

      - name: Set package variables
        run: |
          pkg="${{ github.event.inputs.package_name }}"
          [ -z "$pkg" ] && pkg="luci-app-xlnetacc"
          echo "PKG_NAME=$pkg" >> $GITHUB_ENV

      - name: Prepare feeds
        run: |
          cd "$SDK_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add package
        run: |
          cd "$SDK_DIR"
          mkdir -p "package/$PKG_NAME"
          rsync -a --delete --exclude ".git" --exclude ".github" --exclude ".gitignore" \
            --exclude "*.swp" --exclude ".DS_Store" "$GITHUB_WORKSPACE/" "package/$PKG_NAME/"
          echo "CONFIG_PACKAGE_${PKG_NAME}=m" > .config
          make defconfig

      - name: Build IPK
        run: |
          cd "$SDK_DIR"
          make package/$PKG_NAME/compile -j$(nproc) V=s
          ipk_matches=$(find "$SDK_DIR/bin/packages" -name "${PKG_NAME}*.ipk")
          if [ -z "$ipk_matches" ]; then
            echo "IPK not found"
            exit 1
          fi
          match_count=$(printf "%s\n" "$ipk_matches" | grep -c .)
          if [ "$match_count" -gt 1 ]; then
            echo "Multiple IPKs found:"
            echo "$ipk_matches"
            ipk_path=$(echo "$ipk_matches" | head -n 1)
            echo "Using first: $ipk_path"
          else
            ipk_path="$ipk_matches"
          fi
          echo "Found IPK: $ipk_path"
          echo "IPK_PATH=$ipk_path" >> $GITHUB_ENV
          echo "IPK_NAME=$(basename "$ipk_path")" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}-ipk
          path: ${{ env.IPK_PATH }}

      - name: Set release variables
        run: |
          rel_tag="${{ github.event.inputs.release_tag }}"
          rel_name="${{ github.event.inputs.release_name }}"
          [ -z "$rel_tag" ] && rel_tag="ipk-build-${GITHUB_RUN_NUMBER}"
          [ -z "$rel_name" ] && rel_name="Manual IPK build ${GITHUB_RUN_NUMBER}"
          echo "REL_TAG=$rel_tag" >> $GITHUB_ENV
          echo "REL_NAME=$rel_name" >> $GITHUB_ENV

      - name: Publish release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh release view "$REL_TAG" >/dev/null 2>&1; then
            gh release create "$REL_TAG" --title "$REL_NAME" --notes "Automated IPK build."
          fi
          gh release upload "$REL_TAG" "$IPK_PATH" --clobber
